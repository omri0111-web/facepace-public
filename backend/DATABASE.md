# Database Schema Documentation

## Overview
This application uses SQLite for data persistence. The database stores information about people, their face embeddings for recognition, groups, and group memberships.

## Database File
- **Location**: `backend/faces.db`
- **Type**: SQLite 3
- **Journal Mode**: WAL (Write-Ahead Logging) for better concurrency

## Tables

### 1. `persons`
Stores information about individuals in the system.

| Column | Type | Description |
|--------|------|-------------|
| `person_id` | TEXT | Primary key, unique identifier for each person |
| `person_name` | TEXT | Full name of the person |
| `photo_paths` | TEXT | JSON array of photo filenames stored in `/backend/photos/{person_id}/` |

**Example**:
```sql
INSERT INTO persons (person_id, person_name, photo_paths) 
VALUES ('1234567890', 'John Doe', '["abc123.jpg", "def456.jpg"]');
```

### 2. `embeddings`
Stores face recognition embeddings for each person.

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER | Primary key, auto-increment |
| `person_id` | TEXT | Foreign key to `persons.person_id` |
| `embedding` | BLOB | Binary face embedding vector (512 dimensions) |
| `created_at` | REAL | Unix timestamp when embedding was created |

**Notes**:
- Multiple embeddings per person are supported (multi-angle enrollment)
- Embeddings are generated by InsightFace model
- Used for face recognition/matching

### 3. `groups`
Stores group information (e.g., patrols, classes).

| Column | Type | Description |
|--------|------|-------------|
| `group_id` | TEXT | Primary key, unique identifier for each group |
| `group_name` | TEXT | Name of the group |
| `age` | TEXT | Age group (optional) |
| `guides_info` | TEXT | Guides names and phone numbers (optional) |
| `notes` | TEXT | Additional notes about the group (optional) |

**Example**:
```sql
INSERT INTO groups (group_id, group_name, age, guides_info, notes) 
VALUES ('patrol_1', 'Eagle Patrol', '12-14', 'John Doe - 555-1234', 'Meets on Tuesdays');
```

### 4. `group_members`
Junction table for many-to-many relationship between groups and people.

| Column | Type | Description |
|--------|------|-------------|
| `group_id` | TEXT | Foreign key to `groups.group_id` |
| `person_id` | TEXT | Foreign key to `persons.person_id` |

**Primary Key**: Composite of (`group_id`, `person_id`)

**Example**:
```sql
INSERT INTO group_members (group_id, person_id) 
VALUES ('patrol_1', '1234567890');
```

## Relationships

```
persons (1) ----< (N) embeddings
persons (N) ----< (N) group_members >---- (N) groups
```

## Photo Storage

Photos are stored in the filesystem, not in the database:
- **Directory**: `/backend/photos/{person_id}/`
- **Format**: JPEG
- **Naming**: UUID-based filenames (e.g., `abc123-def456-789.jpg`)
- **Database Reference**: `persons.photo_paths` stores JSON array of filenames

**Example Structure**:
```
backend/
  photos/
    1234567890/
      abc123-def456-789.jpg
      def456-ghi789-012.jpg
    9876543210/
      xyz789-abc012-345.jpg
```

## Indexes

No explicit indexes are currently defined beyond primary keys and foreign keys.

**Recommended Indexes** (for future optimization):
```sql
CREATE INDEX idx_embeddings_person_id ON embeddings(person_id);
CREATE INDEX idx_group_members_group_id ON group_members(group_id);
CREATE INDEX idx_group_members_person_id ON group_members(person_id);
```

## Migrations

The database schema is automatically created/updated on application startup via `init_db()` function in `backend/main.py`.

**Schema Evolution**:
- New columns are added via `ALTER TABLE` if they don't exist
- Existing data is preserved
- No explicit migration system is currently implemented

## Backup & Restore

**Backup**:
```bash
# Database
cp backend/faces.db backend/faces.db.backup

# Photos
tar -czf backend/photos_backup.tar.gz backend/photos/
```

**Restore**:
```bash
# Database
cp backend/faces.db.backup backend/faces.db

# Photos
tar -xzf backend/photos_backup.tar.gz -C backend/
```

## Data Integrity

- **Foreign Keys**: Enabled via SQLite PRAGMA
- **Cascade Deletes**: 
  - Deleting a person removes their embeddings and group memberships
  - Deleting a group removes its memberships
- **Orphan Prevention**: Application logic ensures consistency

## Performance Considerations

- **WAL Mode**: Allows concurrent reads during writes
- **Embedding Search**: Linear scan through all embeddings (O(n))
- **Photo Serving**: Direct filesystem access via FastAPI FileResponse
- **Connection Pooling**: Single connection per request (SQLite limitation)

## Security

- **SQL Injection**: Prevented via parameterized queries
- **File Access**: Photos served only through API endpoint with validation
- **Authentication**: Not currently implemented (admin app)
- **Encryption**: Database and photos are not encrypted at rest

## Future Enhancements

1. Add indexes for faster queries
2. Implement proper migration system
3. Add database encryption
4. Implement connection pooling (if switching to PostgreSQL)
5. Add audit logging for changes
6. Implement soft deletes for data recovery

